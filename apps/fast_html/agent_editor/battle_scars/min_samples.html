<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTMX Dropdown Example</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <style>
      #dropdown {
        display: none;
        border: 1px solid #ccc;
        position: absolute;
        background: #fff;
        z-index: 1000;
      }
      .dropdown-item {
        padding: 5px 10px;
        cursor: pointer;
      }
      .dropdown-item:hover {
        background-color: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <textarea
      id="textArea"
      rows="5"
      cols="40"
      placeholder="Type here..."
    ></textarea>
    <div id="dropdown">
      <div
        class="dropdown-item"
        hx-post="/select-value"
        hx-vals='{"selectedValue": "Option1"}'
      >
        Option1
      </div>
      <div
        class="dropdown-item"
        hx-post="/select-value"
        hx-vals='{"selectedValue": "Option2"}'
      >
        Option2
      </div>
      <div
        class="dropdown-item"
        hx-post="/select-value"
        hx-vals='{"selectedValue": "Option3"}'
      >
        Option3
      </div>
    </div>

    <script>
      const textarea = document.getElementById("textArea");
      const dropdown = document.getElementById("dropdown");

      textarea.addEventListener("input", function (event) {
        const cursorPosition = textarea.selectionStart;
        const text = textarea.value;
        const triggerIndex = text.lastIndexOf("#", cursorPosition - 1);

        if (triggerIndex !== -1) {
          const { top, left } = textarea.getBoundingClientRect();
          dropdown.style.top = `${
            top + window.scrollY + textarea.offsetHeight
          }px`;
          dropdown.style.left = `${left + window.scrollX}px`;
          dropdown.style.display = "block";
        } else {
          dropdown.style.display = "none";
        }
      });

      document.querySelectorAll(".dropdown-item").forEach((item) => {
        item.addEventListener("click", function () {
          const selectedValue = this.textContent;
          const cursorPosition = textarea.selectionStart;
          const text = textarea.value;
          const triggerIndex = text.lastIndexOf("#", cursorPosition - 1);

          if (triggerIndex !== -1) {
            const before = text.slice(0, triggerIndex);
            console.log(before);
            const after = text.slice(triggerIndex);
            console.log(after);
            textarea.value = `${before}#VALUE HERE${after}`;
          }

          dropdown.style.display = "none";
          textarea.focus();
        });
      });
    </script>
  </body>
</html>
